@using StarWarsApp.Shared

@page "/characters"
@inject HttpClient Http

<a id="top"></a>
<PageTitle>Characters</PageTitle>

<div class="characters-root">
    <h2 class="characters-heading">Characters</h2>

    @if (isLoading)
    {
        <p class="characters-status">Loading characters...</p>
    }
    else if (loadError is not null)
    {
        <p class="characters-status error">@loadError</p>
    }
    else if (characters is null || characters.Count == 0)
    {
        <p class="characters-status">No characters found.</p>
    }
    else
    {
        <div class="characters-list">
            @foreach (var c in PagedCharacters)
            {
                <a class="entity-link"
                  href="@($"/characters/{Uri.EscapeDataString(c.Name)}")">
                    <EntityCard Name="@c.Name"
                                Description="@c.Description"
                                ImageUrl="@c.Image" />
                </a>
            }
        </div>

        <Pager @bind-CurrentPage="currentPage"
               TotalPages="@totalPages" />
    }
</div>

<button class="scroll-to-top" onclick="document.getElementById('top').scrollIntoView({behavior:'smooth'})">
    â†‘
</button>

@code {
    private List<SwCharacter> characters = new();
    private bool isLoading = true;
    private string? loadError;

    private int currentPage = 1;
    private int pageSize = 6; 
    private int totalPages =>
        characters is null || characters.Count == 0
            ? 1
            : (int)Math.Ceiling(characters.Count / (double)pageSize);

    private IEnumerable<SwCharacter> PagedCharacters =>
        characters
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<StarWarsResponse>(
                "https://starwars-databank-server.vercel.app/api/v1/characters"
            );

            characters = response?.Data ?? new();
            currentPage = 1;
        }
        catch (Exception ex)
        {
            loadError = "Failed to load characters: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    public class StarWarsResponse
    {
        public List<SwCharacter> Data { get; set; } = new();
    }

    public class SwCharacter
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Image { get; set; } = "";
    }
}
